# 📎 上下文引用

上下文引用是 LLMSider 的核心功能之一，允许您在与 AI 对话时轻松引入各类内容作为上下文，包括笔记、PDF 文档、图片、选中文本等，让 AI 能够基于这些内容提供更准确、更相关的回答。

## ✨ 功能概述

上下文引用支持多种内容类型：

- **Markdown 笔记**：引入单个或多个笔记文件
- **PDF 文档**：自动提取文本内容
- **图片文件**：支持 JPG、PNG、GIF、WebP 等格式（多模态模型）
- **Office 文档**：Word (.docx)、Excel (.xlsx)、PowerPoint (.pptx)
- **选中文本**：当前笔记中的任意选中内容
- **文本片段**：直接粘贴或拖放的文本
- **网页内容**：提取当前网页文本（需要在 Obsidian 内置 Web Viewer 中打开）
- **YouTube 视频**：自动提取字幕内容（需要在 Obsidian 内置 Web Viewer 中打开）

## 🎯 添加上下文的方式

### 方式 1：通过命令面板

1. **引入当前笔记**
   - 打开命令面板：`Ctrl/Cmd + P`
   - 搜索"引入当前笔记"或"Include current note"
   - 当前打开的笔记会被添加为上下文

2. **引入选中文本**
   - 在笔记中选中任意文本
   - 打开命令面板：`Ctrl/Cmd + P`
   - 搜索"引入选中文本"或"Include selected text"
   - 选中的文本会被添加为上下文

### 方式 2：拖放操作

最直观的方式是直接拖放：

1. **拖放笔记文件**
   - 从文件列表拖动笔记到聊天输入框
   - 支持多个文件同时拖放
   - 自动识别 Markdown、PDF 等格式

2. **拖放文件夹**
   - 拖动整个文件夹到输入框
   - 会遍历文件夹中的所有 Markdown 文件
   - 适合批量添加相关笔记

3. **拖放文本内容**
   - 从笔记中拖动选中的文本
   - 从外部应用拖入文本片段
   - 文本会作为独立上下文项添加

4. **拖放图片**
   - 支持从文件系统拖动图片
   - 支持从笔记中拖动已嵌入的图片
   - 需要使用支持视觉能力的模型（如 GPT-4 Vision、Claude 3 等）

### 方式 3：粘贴操作

在聊天输入框中粘贴内容：

- 粘贴文本内容会添加为文本上下文
- 粘贴文件路径会尝试加载该文件
- 支持 Obsidian 内部链接格式（如 `[[笔记名]]`）

### 方式 4：智能搜索

1. 点击聊天界面的"搜索"按钮
2. 在搜索框中输入关键词
3. 从搜索结果中选择文件
4. 选中的文件自动添加为上下文

### 方式 5：快速建议

当您添加一个文件后：

- 系统会自动推荐相关文件
- 相关文件以灰色/待定样式显示
- 点击即可快速添加到上下文

## 📊 上下文类型详解

### 1. Markdown 笔记

- 自动提取完整文本内容
- 保留标题层级结构
- 支持提取嵌入的图片
- 显示字符计数和是否截断信息

**示例场景**：
```
用户：请总结这三篇笔记的共同点
[拖入：笔记A.md, 笔记B.md, 笔记C.md]
```

### 2. PDF 文档

- 自动提取全部文本内容
- 支持多页 PDF
- 提取图片（如启用）
- 受模型 Token 限制，超长文档会被截断

**注意**：
- PDF 解析质量取决于文档格式
- 扫描版 PDF 可能需要 OCR（未内置）
- 建议文档不超过 50-100 页

### 3. 图片文件

- 支持格式：JPG、PNG、GIF、WebP
- 自动转换为 Base64 编码
- 支持多模态模型（GPT-4V、Claude 3、Gemini Pro Vision 等）
- 图片大小受限于模型支持

**使用技巧**：
```
用户：这张图表显示了什么趋势？
[拖入：chart.png]
```

### 4. Office 文档

- **Word (.docx)**：提取文本和表格
- **Excel (.xlsx)**：提取工作表数据
- **PowerPoint (.pptx)**：提取幻灯片文本

**限制**：
- 格式和样式信息会丢失
- 仅提取纯文本内容
- 复杂表格可能格式混乱

### 5. 选中文本

- 支持任意长度文本
- 保留原始格式
- 自动生成预览（前 100 字符）
- 可添加多个选中文本

**快捷操作**：
1. 在笔记中选中文本
2. 使用命令"引入选中文本"
3. 或右键选择相关选项（如启用）

**💡 智能编辑功能**：

当您选择文本作为上下文并让 AI 对其进行修改或重写时，LLMSider 提供了强大的比较和应用功能：

1. **Diff 对比查看**
   - 点击 AI 回复上的 👁️ "切换差异视图" 按钮
   - 系统会以差异对比的方式显示：
     - 🔴 红色：原文中被删除的内容
     - 🟢 绿色：AI 新增的内容
   - 清晰查看 AI 做了哪些具体修改
   - 再次点击可切换回普通渲染视图

2. **一键应用更改**
   - 审阅完差异后，点击 ✅ "应用更改" 按钮
   - 自动将 AI 生成的内容替换原文中选中的部分
   - 无需手动复制粘贴
   - 支持撤销（Ctrl/Cmd + Z）

**典型使用场景**：
```
场景：润色文本
1. 在笔记中选择需要改进的段落
2. 使用"引入选中文本"添加为上下文
3. 提问："请帮我润色这段文字，使其更专业"
4. 查看 AI 回复后，点击 👁️ 查看具体改动
5. 确认无误后，点击 ✅ 应用更改到笔记
```

**注意事项**：
- Apply 和 Diff 功能仅在"选中文本"模式下可用
- 如果同时引入了多个文件，这些按钮会被隐藏
- 应用更改前建议先查看差异，确保修改符合预期

### 6. YouTube 视频

特殊支持：

- 识别 YouTube URL 或视频 ID
- 自动提取字幕（如果可用）
- 转换为文本上下文
- 支持多语言字幕

**重要提示**：
- 需要在 **Obsidian 内置 Web Viewer** 中打开 YouTube 视频
- 打开视频后，可以通过命令面板或拖放 URL 添加为上下文
- 系统会自动从当前打开的视频中提取字幕

**支持的 URL 格式**：
- `https://www.youtube.com/watch?v=VIDEO_ID`
- `https://youtu.be/VIDEO_ID`
- `https://www.youtube.com/embed/VIDEO_ID`
- 直接输入 11 位视频 ID

### 7. 网页内容

特殊支持：

- 提取当前网页的文本内容
- 保留主要文字信息
- 自动过滤广告和导航元素

**重要提示**：
- 需要在 **Obsidian 内置 Web Viewer** 中打开网页
- 打开网页后，可以通过命令面板或快捷键添加当前网页内容
- 适用于阅读文章、博客或文档后让 AI 分析内容

## ⚙️ 上下文管理

### 查看已添加的上下文

- 上下文项显示在聊天输入框上方
- 每项显示名称和类型标识
- 悬停可查看预览或详细信息

### 删除上下文

- 点击上下文项右侧的 ✕ 按钮
- 可单独删除某一项
- 或使用"清除所有上下文"命令

### 查看上下文内容

- 点击上下文项
- 在弹出的模态窗口中查看完整内容
- 支持文本格式化显示

### 上下文持久化

- 上下文与当前会话绑定
- 切换会话时自动清空上下文
- 新会话需要重新添加上下文

## 🔧 高级功能

### 图片提取

启用后可从 Markdown 笔记中自动提取嵌入的图片：

1. 在设置中启用"从 Markdown 提取图片"
2. 添加笔记时自动扫描图片引用
3. 图片作为多模态内容发送给 AI

**适用模型**：
- GPT-4 Vision
- Claude 3 (Opus/Sonnet/Haiku)
- Gemini Pro Vision
- 其他支持视觉的模型

### 相关笔记建议

启用向量数据库后：

- 添加文件时自动查找相关笔记
- 以灰色样式显示建议项
- 一键添加相关内容
- 查看 [搜索增强](search-enhancement.md) 了解详情

### Token 限制处理

- 自动计算上下文 Token 数
- 超出模型限制时自动截断
- 优先保留文件开头内容
- 显示截断警告信息

**优化建议**：
- 使用大上下文模型（如 GPT-4 128K、Claude 200K）
- 仅添加必要的上下文
- 拆分过长文档

### 多模态支持

当使用支持视觉的模型时：

1. 图片会以原生格式发送
2. AI 可直接"看到"图片内容
3. 支持图文混合对话
4. 可同时添加多张图片

## 💡 使用技巧

### 最佳实践

1. **精准上下文**
   - 只添加与问题相关的内容
   - 避免无关信息干扰 AI 判断
   - 优先使用选中文本而非整个笔记

2. **合理分批**
   - 大量文件分多轮对话处理
   - 避免一次性添加过多上下文
   - 观察 AI 响应质量调整策略

3. **格式优化**
   - 使用清晰的标题层级
   - 保持笔记结构完整
   - 避免过多格式化标记

4. **利用缓存**
   - 部分模型支持上下文缓存（如 Claude）
   - 固定上下文放在对话开头
   - 减少重复发送相同内容

### 常见场景

**场景 1：文献综述**
```
1. 添加 3-5 篇相关论文笔记
2. 提问："这些研究有哪些共同发现？"
3. AI 基于所有笔记进行综合分析
```

**场景 2：代码调试**
```
1. 选中出错的代码片段
2. 引入选中文本
3. 提问："这段代码有什么问题？"
```

**场景 3：图表分析**
```
1. 拖入包含图表的图片
2. 提问："请分析这个销售趋势图"
3. AI 识别图表并提供见解
```

**场景 4：知识关联**
```
1. 添加主题笔记
2. 系统自动建议相关笔记
3. 选择添加建议的笔记
4. 提问："这些笔记之间有什么联系？"
```

## 🚫 限制与注意事项

1. **文件大小限制**
   - 受模型上下文窗口限制
   - PDF 和 Office 文档建议 <10MB
   - 图片建议 <5MB（取决于模型）

2. **格式支持**
   - 纯文本文件可能无法正确识别编码
   - 二进制格式需要模型原生支持
   - 部分特殊格式可能解析失败

3. **Token 消耗**
   - 每次对话都会发送所有上下文
   - 大量上下文会增加 API 成本
   - 图片 Token 消耗通常较高

4. **性能影响**
   - 大文件解析可能需要几秒时间
   - 多个文件并发加载会增加延迟
   - 图片编码会占用内存

5. **隐私安全**
   - 上下文内容会发送到 AI 服务商
   - 注意敏感信息保护
   - 使用私有部署模型可提高安全性

## 🛠️ 技术细节

### 文件解析器

LLMSider 使用 `FileParser` 类处理不同文件类型：

- **Markdown**：原生解析，提取文本和图片
- **PDF**：使用 `pdf-parse` 库
- **Office**：使用 mammoth (Word)、xlsx (Excel) 等
- **图片**：转换为 Base64 + MIME 类型

### 上下文数据结构

```typescript
interface NoteContext {
  name: string;           // 文件名
  content: string;        // 文本内容
  filePath?: string;      // 文件路径
  type?: string;          // 文件类型
  metadata?: {
    originalLength?: number;
    truncated?: boolean;
    extractedImages?: ExtractedImage[];
    // ...
  };
}
```

### Token 计算

- 使用 `TokenManager` 估算 Token 数
- 基于 OpenAI tiktoken 库
- 支持不同模型的 Token 限制

## 📚 相关文档

- [聊天界面](chat-interface.md) - 了解聊天功能
- [搜索增强](search-enhancement.md) - 启用相关笔记建议
- [连接与模型](connections-and-models.md) - 配置支持多模态的模型
- [设置指南](settings-guide.md) - 自定义上下文行为

---

**提示**：上下文引用功能让 AI 能够"看到"您的笔记内容，是实现个性化、精准回答的关键。合理使用上下文，可以显著提升 AI 助手的实用价值。
